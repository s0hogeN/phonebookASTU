window.addEventListener("load", () => {
    fetch('/', {
        headers: {'Accept': 'application/json'}
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(employees => {
        console.log(employees);
        const container = document.getElementById('container-main');
        
        if (!employees || !Array.isArray(employees)) {
            throw new Error('Employees data is not an array');
        }

        // Список всех подразделений
        const departments = [
            'Руководители университета',
            'Ученый Совет',
            'Первый отдел',
            'Отдел гражданской обороны, чрезвычайных ситуаций и мобилизационной подготовки',
            'Бухгалтерия',
            'Касса',
            'Бухгалтер по расчету заработной платы',
            'Бухгалтер по расчетам стипендии и иных выплат обучающимся',
            'Бухгалтер по расчетам по найму жилого помещения в общежитии',
            'Бухгалтер по расчетам с подотчетными лицами',
            'Бухгалтер по налоговому учету',
            'Бухгалтер по учету основных средств и материальных запасов',
            'Бухгалтер по расчетам с поставщиками и подрядчиками',
            'Бухгалтер по расчетам с покупателями',
            'Отдел кадров',
            'Юридический отдел',
            'Отдел правового обеспечения финансово-хозяйственной деятельности и проектов',
            'Студенческая канцелярия',
            'Общий отдел',
            'Военно-учетный стол (ВУС)',
            'Архив',
            'Международный отдел',
            'Отдел академической мобильности',
            'Управление массовых коммуникаций и медиа-проектов',
            'Пресс-центр АГТУ',
            'Отдел медиа-проектов',
            'Рекламно-информационный центр',
            'Управление по организационно-воспитательной работе',
            'Отдел по культурно-массовой работе',
            'Отдел по воспитательной и социальной работе',
            'Музей истории АГТУ',
            'Спортивный клуб',
            'Центр социально-психологической помощи «Доверие»',
            'Студенческий совет АГТУ',
            'Профстудком АГТУ',
            'Физкультурно-спортивное сооружение "Спорткомплекс"',
            'Управление информационных систем и технологий',
            'Отдел АСУ',
            'Отдел информационной безопасности',
            'Сервисный отдел',
            'Отдел Вычислительных сетей и связи',
            'Диспетчерский отдел',
            'Учебный отдел',
            'Центр содействия трудоустройству выпускников АГТУ',
            'Отдел методического обеспечения учебного процесса',
            'Центр образовательной политики',
            'Издательство АГТУ',
            'Отдел допечатной подготовки изданий',
            'Редакция научных журналов',
            'Научно-образовательный центр профессиональных компетенций',
            'Центр довузовской подготовки, профориентации и приему в вуз',
            'Научная библиотека',
            'Отдел каталогизации',
            'Отдел научной литературы',
            'Читальный зал электронных ресурсов',
            'Отдел комплектования',
            'Информационно-библиографический отдел',
            'Центр научно-инновационного развития',
            'Отдел научных проектов',
            'Научно-исследовательская часть',
            'Отдел подготовки кадров высшей квалификации',
            'Отдел маркетинга',
            'Договорный отдел',
            'Отдел материально-технического снабжения',
            'Склад',
            'Планово-экономический отдел',
            'Сектор труда и заработной платы',
            'Отдел внебюджетной деятельности и социальной защиты',
            'Административно-хозяйственное управление',
            'Отдел по комплексному обслуживанию вуза',
            'Хозяйственный отдел',
            'Транспортный отдел',
            'Отдел по управлению имуществом и проектами',
            'Отдел охраны труда и техники безопасности',
            'Общежития',
            'Вахты учебных корпусов - Главный учебный корпус',
            'Вахты учебных корпусов - Учебный корпус №2',
            'Вахты учебных корпусов - Учебный корпус №3',
            'Вахты учебных корпусов - Учебный корпус №4',
            'Вахты учебных корпусов - Учебный корпус №5',
            'Вахты учебных корпусов - Учебный корпус №6',
            'Вахты учебных корпусов - Учебный корпус №7',
            'Вахты учебных корпусов - Учебный корпус №8',
            'Вахты учебных корпусов - Учебный корпус №10-11',
            'Дополнительные структуры - Медицинский пункт',
            'Дополнительные структуры - Профсоюзный комитет сотрудников',
            'ИНСТИТУТ ЭКОНОМИКИ И ПРАВА',
            'Заочное отделение ИЭиП',
            'Финансы и учет (ФиУ)',
            'Производственный менеджмент (ПМ)',
            'Экономическая безопасность (ЭКБ)',
            'Правоведение',
            'Экономика и управление предприятием (ЭУП)',
            'Гуманитарные науки и психология (ГНП)',
            'Центр бизнес-образования',
            'Юридическая клиника',
            'ИНСТИТУТ ИНФОРМАЦИОННЫХ ТЕХНОЛОГИЙ И КОММУНИКАЦИЙ',
            'Автоматизированные системы обработки информации и управления (АСОИУ)',
            'Прикладная информатика (ПИ)',
            'Связь (СВ)',
            'Автоматика и управление (АиУ)',
            'Информационная безопасность (ИБ)',
            'Высшая и прикладная математика (ВиПМ)',
            'ИНСТИТУТ МОРСКИХ ТЕХНОЛОГИЙ, ЭНЕРГЕТИКИ И ТРАНСПОРТА',
            'Очное обучение ИМТЭиТ',
            'Заочное обучение ИМТЭиТ',
            'Общеинженерные дисциплины и наземный транспорт (ОДиНТ)',
            'Судостроение и энергетические комплексы морской техники (СиЭК)',
            'Теплоэнергетика и холодильные машины (ТЭНиХМ)',
            'Электрооборудование и автоматика судов (ЭАС)',
            'Эксплуатация водного транспорта и промышленное рыболовство (ЭВТиПР)',
            'Тренажерный центр института морских технологий, энергетики и транспорта (ТЦ ИМТЭиТ)',
            'ИНСТИТУТ НЕФТИ И ГАЗА',
            'Очное отделение ИНиГ',
            'Заочное отделение ИНиГ',
            'Химия',
            'Химическая технология переработки нефти и газа (ХТНГ)',
            'Геология нефти и газа (ГНГ)',
            'Разработка и эксплуатация нефтяных и газовых месторождений (РЭНГ)',
            'Технологические машины и оборудование (ТМО)',
            'ИНСТИТУТ РЫБНОГО ХОЗЯЙСТВА, БИОЛОГИИ И ПРИРОДОПОЛЬЗОВАНИЯ',
            'Заочное отделение ИРБиП',
            'Аквакультура и водные биоресурсы (АВБ)',
            'Научно-исследовательская лаборатория «Осетроводство и перспективные объекты аквакультуры»',
            'Научно-исследовательская лаборатория «Биотехнологии сохранения и воспроизводства ценных видов рыб»',
            'Гидробиология и общая экология (ГОЭ)',
            'Экологический туризм (ЭЛТ)',
            'Иностранные языки и речевая коммуникация (ИЯиРК)',
            'Лингвистический центр',
            'Центр тестирования иностранных граждан',
            'Технология товаров и товароведение (ТТТ)',
            'Прикладная биология и микробиология (ПБМ)',
            'ИНСТИТУТ ГРАДОСТРОИТЕЛЬСТВА',
            'Строительство (СТР)',
            'Архитектура (АРХ)',
            'ФАКУЛЬТЕТ СРЕДНЕГО ПРОФЕССИОНАЛЬНОГО ОБРАЗОВАНИЯ',
            'Отделение "Связь и телекоммуникации"',
            'Отделение "Общеобразовательные дисциплины"',
            'Отделение "Нефтегазовое"',
            'Отделение "Сервис и право"',
            'Отделение "Финансово-экономическое"',
            'Отделение "Техническое"',
            'СП "Центр профессионального развития"',
            'ИНСТИТУТ ДОПОЛНИТЕЛЬНОГО ПРОФЕССИОНАЛЬНОГО ОБРАЗОВАНИЯ',
            'ПОДГОТОВИТЕЛЬНЫЙ ФАКУЛЬТЕТ ДЛЯ ИНОСТРАННЫХ ГРАЖДАН',
            'Автотехнический учебный центр повышения квалификации и переподготовки',
            'Дмитровский рыбохозяйственный технологический институт',
            'Ейский морской рыбопромышленный техникум',
            'Волго-Каспийский морской рыбопромышленный колледж',
            'Филиал ФГБОУ ВО Астраханский государственный технический университет в Ташкентской области'
        ];

        // Создаем объект для хранения HTML по подразделениям
        const departmentHtml = {};
        
        // Инициализируем HTML для каждого подразделения
        departments.forEach(dept => {
            departmentHtml[dept] = `<div class="unit-title">${dept}</div>`;
        });

        // Функция для создания строки сотрудника
        function createEmployeeRow(emp) {
            let short = emp.short_num.split(" ");
            let email = emp.email.split(" ");
            
            let phoneHtml = '';
            if (emp.short_num !== '') {
                short.forEach(num => {
                    if (num.length == 4) {
                        phoneHtml += `8(8512)61-4${num}<br>`;
                    } else {
                        phoneHtml += `${num}<br>`;
                    }
                });
                
                return `
                    <div class="container-row">
                        <div class="cont-el"><p>${emp.fio || '-'}</p></div>
                        <div class="cont-el phone-num"><p>${phoneHtml}</p></div>
                        <div class="cont-el phone-num"><p>${emp.short_num}</p></div>
                        <div class="cont-el job-title"><p>${emp.job_title || '-'}</p></div>
                        <div class="cont-el email"><p>${email.map(em => `<a href="mailto:${em}"><img src="/static/img/mail.png">${em}</a>`).join('<br>')}</p></div>
                        <div class="cont-el cabinet"><p>${emp.cabinet || '-'}</p></div>
                    </div>
                `;
            } else {
                return `
                    <div class="container-row">
                        <div class="cont-el"><p>${emp.fio || '-'}</p></div>
                        <div class="cont-el phone-num"><p>-</p></div>
                        <div class="cont-el phone-num"><p>-</p></div>
                        <div class="cont-el job-title"><p>${emp.job_title || '-'}</p></div>
                        <div class="cont-el email"><p><a href="mailto:${emp.email}"><img src="/static/img/mail.png">${emp.email}</a></p></div>
                        <div class="cont-el cabinet"><p>${emp.cabinet || '-'}</p></div>
                    </div>
                `;
            }
        }

        // Распределяем сотрудников по подразделениям
        employees.forEach(emp => {
            if (departmentHtml.hasOwnProperty(emp.unit)) {
                departmentHtml[emp.unit] += createEmployeeRow(emp);
            }
        });

        // Собираем весь HTML в одну строку
        let fullHtml = '';
        departments.forEach(dept => {
            fullHtml += departmentHtml[dept];
        });

        // Вставляем HTML в контейнер
        container.innerHTML = fullHtml;
    })
    .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
        container.innerHTML = '<div class="error-message">Произошла ошибка при загрузке данных. Пожалуйста, попробуйте позже.</div>';
    });
});